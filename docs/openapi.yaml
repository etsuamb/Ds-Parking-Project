openapi: 3.0.3
info:
  title: Distributed Smart Parking System API
  description: |
    REST API specification for the Distributed Smart Parking System.
    Includes public-facing client APIs and internal service-to-service APIs.
  version: 1.0.0

servers:
  - url: http://localhost:3000
    description: Local development server

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

    internalAuth:
      type: apiKey
      in: header
      name: X-Internal-Token

security:
  - bearerAuth: []

paths:
  # ─────────────────────────────────────────────
  # PUBLIC API (Client → API Gateway)
  # ─────────────────────────────────────────────

  /auth/register:
    post:
      summary: Register a new user
      tags: [Authentication]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username, password]
              properties:
                username:
                  type: string
                  example: john_doe
                password:
                  type: string
                  format: password
      responses:
        "201":
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User registered successfully
        "409":
          description: Username already exists

  /auth/login:
    post:
      summary: Authenticate user and obtain JWT
      tags: [Authentication]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username, password]
              properties:
                username:
                  type: string
                password:
                  type: string
      responses:
        "200":
          description: Authentication successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string

  /parking-lots:
    get:
      summary: List parking lots with availability
      tags: [Parking]
      responses:
        "200":
          description: List of parking lots
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id: { type: integer }
                    name: { type: string }
                    location: { type: string }
                    totalSpots: { type: integer }
                    availableSpots: { type: integer }

  /parking-lots/{lotId}:
    get:
      summary: Get parking lot details
      tags: [Parking]
      parameters:
        - name: lotId
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Parking lot details
          content:
            application/json:
              schema:
                type: object
                properties:
                  id: { type: integer }
                  name: { type: string }
                  location: { type: string }
                  spots:
                    type: array
                    items:
                      type: object
                      properties:
                        spotId: { type: integer }
                        status: { type: string }

  /bookings:
    post:
      summary: Create a new booking
      tags: [Bookings]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [lotId]
              properties:
                lotId: { type: integer }
                spotId: { type: integer }
      responses:
        "201":
          description: Booking created
          content:
            application/json:
              schema:
                type: object
                properties:
                  bookingId: { type: integer }
                  status:
                    type: string
                    example: CONFIRMED

  /bookings/{bookingId}:
    get:
      summary: Get booking details
      tags: [Bookings]
      parameters:
        - name: bookingId
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Booking details
        "404":
          description: Booking not found

    delete:
      summary: Cancel a booking
      tags: [Bookings]
      parameters:
        - name: bookingId
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Booking cancelled

  # ─────────────────────────────────────────────
  # INTERNAL SERVICE-TO-SERVICE APIs
  # ─────────────────────────────────────────────

  /internal/users:
    post:
      summary: Internal - Create user record
      tags: [Internal - Auth]
      security:
        - internalAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username, passwordHash]
              properties:
                username: { type: string }
                passwordHash: { type: string }
      responses:
        "201":
          description: User created internally

  /internal/bookings:
    post:
      summary: Internal - Create booking record
      tags: [Internal - Booking]
      security:
        - internalAuth: []
      responses:
        "201":
          description: Booking stored

  /internal/bookings/{id}:
    get:
      summary: Internal - Get booking details
      tags: [Internal - Booking]
      security:
        - internalAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Booking details

  /internal/parking-lots/{lotId}/spots/{spotId}/reserve:
    post:
      summary: Internal - Reserve parking spot
      tags: [Internal - Parking]
      security:
        - internalAuth: []
      parameters:
        - name: lotId
          in: path
          required: true
          schema: { type: integer }
        - name: spotId
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Spot reserved

  /internal/parking-lots/{lotId}/spots/{spotId}/release:
    post:
      summary: Internal - Release parking spot
      tags: [Internal - Parking]
      security:
        - internalAuth: []
      parameters:
        - name: lotId
          in: path
          required: true
          schema: { type: integer }
        - name: spotId
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Spot released
